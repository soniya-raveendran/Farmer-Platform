<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Products</title>

  <link rel="stylesheet" href="admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>

  <!-- ✅ Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fa-solid fa-seedling"></i>
      ROOTS
    </div>

    <nav class="menu">
      <a href="admin-dashboard.html"><i class="fa-solid fa-gauge"></i> Dashboard</a>
      <a href="admin-users.html"><i class="fa-solid fa-users"></i> Manage Users</a>

      <a href="admin-products.html" class="active">
        <i class="fa-solid fa-box"></i> Products
      </a>

      <a href="./admin-orders.html"><i class="fa-solid fa-receipt"></i> Orders</a>
      <a href="#"><i class="fa-solid fa-chart-line"></i> Reports & Analytics</a>
      <a href="admin-complaints.html"><i class="fa-solid fa-circle-exclamation"></i> Complaints</a>
      <a href="admin-reviews.html"><i class="fa-solid fa-comment-dots"></i> Reviews</a>
      <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
    </nav>

    <button class="logout-btn" onclick="logout()">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </aside>

  <!-- ✅ Main -->
  <main class="main">

    <!-- ✅ Topbar -->
    <header class="topbar">
      <div class="breadcrumb">
        <h2>Products</h2>
        <p>ADMIN / Products</p>
      </div>

      <div class="top-actions">
        <button class="top-btn"><i class="fa-solid fa-shield-halved"></i> Admin Panel</button>
        <button class="top-btn"><i class="fa-solid fa-triangle-exclamation"></i> Alerts</button>
      </div>
    </header>

    <!-- ✅ Title -->
    <section class="page-title">
      <h1>Products Management</h1>
      <p>View all products added by farmers</p>
    </section>

    <!-- ✅ Search + Filter -->
    <section class="table-card" style="margin-bottom:16px;">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;">

        <div style="flex:1;min-width:220px;display:flex;gap:10px;align-items:center;">
          <div
            style="flex:1;display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;">
            <i class="fa-solid fa-magnifying-glass" style="color:#6b7280;"></i>
            <input id="searchInput" placeholder="Search product name..."
              style="border:none;outline:none;width:100%;font-size:14px;" oninput="renderProducts()" />
          </div>
        </div>

        <div style="display:flex;gap:10px;">
          <select id="filterSelect" onchange="renderProducts()"
            style="padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;outline:none;">
            <option value="ALL">All Products</option>
            <option value="FARMER">Farmer Products</option>
          </select>

          <button class="top-btn" onclick="loadProducts()">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
        </div>

      </div>
    </section>

    <!-- ✅ Products Table -->
    <section class="table-card">
      <table class="table">
        <thead>
          <tr>
            <th>PRODUCT</th>
            <th>PRICE</th>
            <th>QUANTITY</th>
            <th>ADDED BY</th>
            <th>EMAIL</th>
          </tr>
        </thead>

        <tbody id="productsBody">
          <tr>
            <td colspan="5" style="text-align:center;color:#6b7280;padding:18px;">
              Loading products...
            </td>
          </tr>
        </tbody>
      </table>
    </section>

  </main>

  <script>
    function logout() {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    let allProducts = [];

    function getImageUrl(p) {
      if (!p.imageUrl) return "https://placehold.co/400x400?text=ROOTS";

      return p.imageUrl.startsWith("http")
        ? p.imageUrl
        : (p.imageUrl.startsWith("uploads")
          ? `http://localhost:8080/${p.imageUrl}`
          : `http://localhost:8080/uploads/${p.imageUrl}`);
    }

    async function loadProducts() {
      const tbody = document.getElementById("productsBody");
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;color:#6b7280;padding:18px;">
            Loading products...
          </td>
        </tr>
      `;

      try {
        const res = await fetch("http://localhost:8080/api/admin/products");
        const products = await res.json();

        allProducts = products || [];
        renderProducts();

      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center;color:red;padding:18px;">
              ❌ Failed to load products
            </td>
          </tr>
        `;
      }
    }

    function renderProducts() {
      const tbody = document.getElementById("productsBody");

      const searchText = document.getElementById("searchInput").value.toLowerCase().trim();
      const filter = document.getElementById("filterSelect").value;

      let filtered = allProducts;

      // ✅ Search filter
      if (searchText) {
        filtered = filtered.filter(p =>
          (p.name || "").toLowerCase().includes(searchText)
        );
      }

      // ✅ Farmer filter (based on farmer object)
      if (filter === "FARMER") {
        filtered = filtered.filter(p => p.farmer != null);
      }

      if (!filtered || filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center;color:#6b7280;padding:18px;">
              No products found.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = "";

      filtered.forEach(p => {
        const farmer = p.farmer || {};
        const farmerName = farmer.name || "Unknown Farmer";
        const farmerEmail = farmer.email || "-";

        tbody.innerHTML += `
          <tr>
            <td>
              <div style="display:flex;align-items:center;gap:12px;">
                <img src="${getImageUrl(p)}"
                     style="width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid #e5e7eb;" />
                <div>
                  <div style="font-weight:800;">${p.name || "Product"}</div>
                  <div style="font-size:12px;color:#6b7280;">ID: #${p.id}</div>
                </div>
              </div>
            </td>

            <td style="font-weight:800;color:#0f7d44;">₹${p.price || 0}</td>

            <td style="font-weight:700;">${p.quantity || 0}</td>

            <td>${farmerName}</td>
            <td style="color:#374151;">${farmerEmail}</td>
          </tr>
        `;
      });
    }

    loadProducts();
  </script>
</body>

</html>