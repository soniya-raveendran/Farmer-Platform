<!DOCTYPE html>
<html>

<head>
  <title>Payment</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>

  <h2>Initializing Payment...</h2>

  <script>
    const orderId = new URLSearchParams(window.location.search).get("orderId");

    if (!orderId) {
      alert("Invalid Order ID");
      window.location.href = "myorder.html";
    } else {
      // Auto-trigger payment
      initiatePayment();
    }

    async function initiatePayment() {
      try {
        const res = await fetch(`http://localhost:8080/api/payment/create/${orderId}`, {
          method: "POST"
        });

        if (!res.ok) throw new Error("Failed to create payment order");

        const order = await res.json();

        const options = {
          key: "rzp_test_S1naQpKeGtkiPp", // Updated from application.properties
          amount: order.amount,
          currency: order.currency || "INR",
          name: "AgriTrade",
          description: "Order Payment",
          order_id: order.id,
          handler: async function (response) {
            try {
              const verifyRes = await fetch("http://localhost:8080/api/payment/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(response)
              });

              if (verifyRes.ok) {
                alert("✅ Payment Successful");
                window.location.href = "myorder.html";
              } else {
                alert("❌ Payment verification failed");
              }
            } catch (err) {
              console.error(err);
              alert("❌ Error verifying payment");
            }
          },
          prefill: {
            name: "",
            email: "",
            contact: ""
          },
          theme: {
            color: "#10b981"
          }
        };

        const rzp = new Razorpay(options);
        rzp.open();

        rzp.on('payment.failed', function (response) {
          alert("❌ Payment Failed: " + response.error.description);
        });

      } catch (err) {
        console.error(err);
        alert("❌ Failed to initiate payment. Check if backend is running.");
      }
    }
  </script>

</body>

</html>