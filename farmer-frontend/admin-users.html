<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management</title>

  <link rel="stylesheet" href="admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* ===============================
   FIXED SIDEBAR (ADMIN + FARMER)
================================ */

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 260px;
      overflow-y: auto;
      z-index: 1000;
      background: #ffffff;
      border-right: 1px solid #eaeaea;
    }

    /* Main content moves beside sidebar */
    .main {
      margin-left: 260px;
      min-height: 100vh;
      padding-bottom: 40px;
    }

    /* Prevent body horizontal scroll */
    body {
      overflow-x: hidden;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.6);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
      position: relative;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .doc-images {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .doc-card {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }

    .doc-card img {
      max-width: 300px;
      max-height: 200px;
      border-radius: 4px;
      margin-top: 10px;
      cursor: pointer;
    }

    .action-buttons {
      margin-top: 20px;
      text-align: center;
    }

    .approve-btn {
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }

    .reject-btn {
      background-color: #dc3545;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>

<body>

  <!-- ✅ Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fa-solid fa-seedling"></i>
      ROOtS
    </div>

    <nav class="menu">
      <a href="admin-dashboard.html"><i class="fa-solid fa-gauge"></i> Dashboard</a>
      <a href="admin-users.html" class="active"><i class="fa-solid fa-users"></i> Manage Users</a>
      <a href="./admin-products.html"><i class="fa-solid fa-box"></i> Products</a>
      <a href="#"><i class="fa-solid fa-receipt"></i> Orders</a>
      <a href="#"><i class="fa-solid fa-money-bill-wave"></i> Payments</a>
      <a href="#"><i class="fa-solid fa-chart-line"></i> Reports & Analytics</a>
      <a href="admin-complaints.html"><i class="fa-solid fa-circle-exclamation"></i> Complaints</a>
      <a href="admin-reviews.html"><i class="fa-solid fa-comment-dots"></i> Reviews</a>
      <a href="#"><i class="fa-solid fa-bell"></i> Notifications</a>
      <a href="#"><i class="fa-solid fa-user-circle"></i> Profile</a>
      <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
    </nav>

    <button class="logout-btn" onclick="logout()">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </aside>

  <!-- ✅ Main -->
  <main class="main">

    <!-- ✅ Topbar -->
    <header class="topbar">
      <div class="breadcrumb">
        <h2>User Management</h2>
        <p>ADMIN / User Management</p>
      </div>

      <div class="top-actions">
        <button class="top-btn"><i class="fa-solid fa-shield-halved"></i> Admin Panel</button>
        <button class="top-btn"><i class="fa-solid fa-triangle-exclamation"></i> Alerts</button>
        <button class="top-btn"><i class="fa-solid fa-chart-simple"></i> System Status</button>
      </div>
    </header>

    <!-- ✅ Title -->
    <section class="page-title">
      <h1>User Management</h1>
      <p>View and manage all registered users.</p>
    </section>

    <!-- ✅ Users Table -->
    <section class="table-card">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>NAME</th>
            <th>EMAIL</th>
            <th>PHONE</th>
            <th>ROLE</th>
            <th>STATUS</th>
            <th>VERIFICATION</th> <!-- Changed Header -->
          </tr>
        </thead>

        <tbody id="usersBody">
          <!-- Rows will be injected here -->
        </tbody>
      </table>
    </section>

  </main>

  <!-- The Modal -->
  <div id="docModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Verification Documents</h2>
      <div id="modalBody">
        <!-- Content injected via JS -->
      </div>
    </div>
  </div>

  <script>
    function logout() {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    function roleBadge(role) {
      const r = (role || "").toUpperCase();
      if (r.includes("FARMER")) return `<span class="badge farmer">FARMER</span>`;
      if (r.includes("RETAILER")) return `<span class="badge retailer">RETAILER</span>`;
      if (r.includes("ADMIN")) return `<span class="badge admin">ADMIN</span>`;
      return `<span class="badge">UNKNOWN</span>`;
    }

    function statusBadge(active) {
      return active
        ? `<span class="badge active">Active</span>`
        : `<span class="badge admin">Blocked</span>`;
    }

    // Toggle Block / Delete functions removed as per request "action field is not necessary" 
    // If needed back, uncomment from previous version.

    let currentDocId = null;

    function openModal(doc) {
      const modal = document.getElementById("docModal");
      const body = document.getElementById("modalBody");
      const title = document.getElementById("modalTitle");

      currentDocId = doc.id;
      title.innerText = `Verify Farmer: ${doc.farmer.name} (ID: ${doc.farmer.id})`;

      body.innerHTML = `
            <div class="doc-images">
                <div class="doc-card">
                    <h4>Aadhaar Card</h4>
                    <p>Number: <b>${doc.aadhaarNumber || 'N/A'}</b></p>
                    <a href="${doc.aadhaarImageUrl}" target="_blank">
                        <img src="${doc.aadhaarImageUrl}" alt="Aadhaar Image">
                    </a>
                </div>
                <div class="doc-card">
                    <h4>PAN Card</h4>
                    <p>Number: <b>${doc.panNumber || 'N/A'}</b></p>
                    <a href="${doc.panImageUrl}" target="_blank">
                        <img src="${doc.panImageUrl}" alt="PAN Image">
                    </a>
                </div>
            </div>
            
            <div class="action-buttons">
                ${doc.status === 'PENDING' ? `
                    <button class="approve-btn" onclick="verifyAction('APPROVED')"><i class="fa-solid fa-check"></i> Approve</button>
                    <button class="reject-btn" onclick="verifyAction('REJECTED')"><i class="fa-solid fa-xmark"></i> Reject</button>
                ` : `<p>Status: <b>${doc.status}</b></p>`}
            </div>
            ${doc.status === 'REJECTED' ? `<p style="text-align:center;color:red;">Reason: ${doc.rejectionReason}</p>` : ''}
        `;

      modal.display = "block"; // Wrong property, handled by CSS class or style
      modal.style.display = "block";
    }

    function closeModal() {
      document.getElementById("docModal").style.display = "none";
    }

    // Close when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById("docModal");
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    async function verifyAction(status) {
      let reason = null;
      if (status === 'REJECTED') {
        reason = prompt("Please enter the reason for rejection:");
        if (!reason) return; // Cancelled
      }

      try {
        let url = `http://localhost:8080/api/verification/${currentDocId}/status?status=${status}`;
        if (reason) url += `&reason=${encodeURIComponent(reason)}`;

        const res = await fetch(url, { method: "PUT" });
        if (res.ok) {
          alert(`Verification ${status} successfully!`);
          closeModal();
          loadUsers(); // Refresh table
        } else {
          alert("Failed to update status.");
        }
      } catch (err) {
        console.error(err);
        alert("Error updating status.");
      }
    }

    async function loadUsers() {
      const tbody = document.getElementById("usersBody");
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;">Loading users...</td></tr>`;

      try {
        const res = await fetch("http://localhost:8080/api/admin/users");
        const users = await res.json();

        tbody.innerHTML = "";

        for (const u of users) {
          let verificationCell = "-";

          if ((u.role || "").toUpperCase().includes("FARMER")) {
            // Fetch doc status
            try {
              const vRes = await fetch(`http://localhost:8080/api/verification/${u.id}`);
              if (vRes.ok) {
                const doc = await vRes.json();
                if (doc && doc.id) {
                  // Storing doc in data attribute or passing directly is tricky with string interpolation
                  // We'll attach the doc object to a global map or fetch on click? 
                  // Easiest is to pass doc ID and fetch again, or encode necessary data.
                  // Or since we are inside a loop, we can create the element using DOM API to attach data.
                  // But for simplicity with template literal, let's just use a global store or fetch on open.
                  // Better: pass the doc object as JSON string (escaped)? No, risky.
                  // Let's store doc in a temporary map.
                  window[`doc_${doc.id}`] = doc;

                  const btnLabel = doc.status === 'PENDING' ? 'Review Docs' : 'View Docs';
                  const btnColor = doc.status === 'PENDING' ? '#eab308' : '#6b7280';

                  verificationCell = `
                        <span class="badge ${doc.status.toLowerCase()}">${doc.status}</span>
                        <button style="margin-left:10px; padding:5px 10px; border:none; background:${btnColor}; color:white; border-radius:4px; cursor:pointer;" 
                                onclick='openModal(window["doc_${doc.id}"])'>
                            <i class="fa-solid fa-eye"></i> ${btnLabel}
                        </button>
                    `;
                } else {
                  verificationCell = `<span class="badge">Not Submitted</span>`;
                }
              } else {
                verificationCell = `<span class="badge">Not Submitted</span>`;
              }
            } catch (e) { console.log(e); }
          } else {
            verificationCell = `<span style="color:#aaa;">N/A</span>`; // Not a farmer
          }

          const active = (u.active === undefined) ? true : u.active;
          const role = (u.role || "").toUpperCase();

          tbody.innerHTML += `
          <tr>
            <td>#${u.id}</td>
            <td>${u.name || "User"}</td>
            <td>${u.email || "-"}</td>
            <td>${u.phone || "-"}</td>
            <td>${roleBadge(role)}</td>
            <td>${statusBadge(active)}</td>
            <td>${verificationCell}</td>
          </tr>
        `;
        }
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;">Failed to load users</td></tr>`;
      }
    }

    loadUsers();

  </script>
</body>

</html>