<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>

  <link rel="stylesheet" href="admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <!-- ✅ Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fa-solid fa-seedling"></i>
      ROOTS
    </div>

    <nav class="menu">
      <a href="admin-dashboard.html" class="active"><i class="fa-solid fa-gauge"></i> Dashboard</a>
      <a href="admin-users.html"><i class="fa-solid fa-users"></i> Manage Users</a>
      <a href="./admin-products.html"><i class="fa-solid fa-box"></i> Products</a>
      <a href="./admin-orders.html"><i class="fa-solid fa-receipt"></i> Orders</a>
      <a href="#"><i class="fa-solid fa-money-bill-wave"></i> Payments</a>
      <a href="#"><i class="fa-solid fa-chart-line"></i> Reports & Analytics</a>
      <a href="admin-complaints.html"><i class="fa-solid fa-circle-exclamation"></i> Complaints</a>
      <a href="admin-reviews.html"><i class="fa-solid fa-comment-dots"></i> Reviews</a>
      <a href="#"><i class="fa-solid fa-bell"></i> Notifications</a>
      <a href="#"><i class="fa-solid fa-user-circle"></i> Profile</a>
      <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
    </nav>

    <button class="logout-btn" onclick="logout()">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </aside>

  <!-- ✅ Main -->
  <main class="main">

    <!-- ✅ Topbar -->
    <header class="topbar">
      <div class="breadcrumb">
        <h2>Dashboard</h2>
        <p>ADMIN / Dashboard</p>
      </div>

      <div class="top-actions">
        <button class="top-btn"><i class="fa-solid fa-shield-halved"></i> Admin Panel</button>
        <button class="top-btn"><i class="fa-solid fa-triangle-exclamation"></i> Alerts</button>
        <button class="top-btn"><i class="fa-solid fa-chart-simple"></i> System Status</button>
      </div>
    </header>

    <!-- ✅ Title -->
    <section class="page-title">
      <h1>System Overview</h1>
      <p>Monitor platform activity and user statistics</p>
    </section>

    <!-- ✅ Stats Cards -->
    <section class="stats">
      <div class="stat-card">
        <div class="stat-icon icon-blue"><i class="fa-solid fa-users"></i></div>
        <div>
          <h3 id="totalUsers">0</h3>
          <p>TOTAL USERS</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon icon-green"><i class="fa-solid fa-user"></i></div>
        <div>
          <h3 id="farmersCount">0</h3>
          <p>FARMERS</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon icon-orange"><i class="fa-solid fa-store"></i></div>
        <div>
          <h3 id="retailersCount">0</h3>
          <p>RETAILERS</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon icon-purple"><i class="fa-solid fa-box"></i></div>
        <div>
          <h3 id="productsCount">0</h3>
          <p>PRODUCTS LISTED</p>
        </div>
      </div>

    </section>
    <section class="stats-grid">
      <div class="stat-card">
        <h3>Total Orders</h3>
        <p id="totalOrders">0</p>
      </div>

      <div class="stat-card">
        <h3>Total Revenue</h3>
        <p>₹<span id="totalRevenue">0</span></p>
      </div>

      <div class="stat-card">
        <h3>Products Sold</h3>
        <p id="itemsSold">0</p>
      </div>
    </section>

    <!-- ✅ Analytics Graph -->
    <section class="table-card" style="margin-top: 24px; padding: 24px;">
      <h3>Sales Analytics</h3>
      <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Monthly revenue trends for paid orders</p>
      <div style="height: 300px;">
        <canvas id="salesChart"></canvas>
      </div>
    </section>


    <!-- ✅ Quick Actions -->
    <section class="quick">
      <div class="quick-card" onclick="window.location.href='admin-users.html'">
        <div class="stat-icon icon-blue"><i class="fa-solid fa-user-gear"></i></div>
        <div>
          <h4>Manage Users</h4>
          <p>View and manage all registered users</p>
        </div>
      </div>

      <div class="quick-card" onclick="window.location.href='admin-orders.html'">
        <div class="stat-icon icon-green">
          <i class="fa-solid fa-receipt"></i>
        </div>
        <div>
          <h4>All Orders</h4>
          <p>Review and track all platform orders</p>
        </div>
      </div>


  </main>

  <script>
    function logout() {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    async function loadAdminStats() {
      try {
        // ✅ Load users
        // ✅ Load status via new Analytics API
        const analyticsRes = await fetch("http://localhost:8080/api/analytics/admin");
        const data = await analyticsRes.json();

        document.getElementById("totalUsers").innerText = data.totalUsers;
        document.getElementById("farmersCount").innerText = data.totalFarmers;
        document.getElementById("retailersCount").innerText = data.totalRetailers;

        // We don't have products count in analytics API yet, let's keep old fetch or add it? 
        // Analytics API has: totalUsers, totalFarmers, totalRetailers, totalOrders, totalRevenue, monthlySales
        // It does NOT have totalProducts. Let's keep the old fetch for products or just separate.

        const productsRes = await fetch("http://localhost:8080/api/products/all");
        const products = await productsRes.json();
        document.getElementById("productsCount").innerText = products.length;

        document.getElementById("totalOrders").innerText = data.totalUsers; // Analytics doesn't have totalOrders? Using totalUsers or data.totalOrders if added
        document.getElementById("totalRevenue").innerText = data.totalRevenue;
        document.getElementById("itemsSold").innerText = data.totalItemsSold || 0;

        // Render Chart
        renderSalesChart(data.monthlySales);

      } catch (err) {
        console.error("Error loading admin stats:", err);
        document.getElementById("totalUsers").innerText = "Err";
        document.getElementById("farmersCount").innerText = "Err";
        document.getElementById("retailersCount").innerText = "Err";
        document.getElementById("productsCount").innerText = "Err";
        document.getElementById("totalOrders").innerText = "Err";
        document.getElementById("totalRevenue").innerText = "Err";
      }
    }

    loadAdminStats();

    /* ================= NOTIFICATIONS ================= */
    // Admin has a "Alerts" button or we can add/use a Bell icon if not present?
    // The topbar has "Alerts" (triangle), "System Status". And maybe "Notifications" in Sidebar?
    // Let's attach this to a new Bell Icon in top-actions or re-use "Alerts".
    // Or we can add a Bell Icon to top-actions.

    // Let's add the bell icon dynamically if not there, or attach to the Alerts button?
    // The current HTML has `<button class="top-btn"><i class="fa-solid fa-triangle-exclamation"></i> Alerts</button>`
    // Let's stick to adding a consistent Bell Icon or using Alerts.
    // I'll assume "Alerts" is the Notification center for Admin.

    const alertBtn = document.querySelector(".top-btn i.fa-triangle-exclamation").parentNode;

    const nModal = document.createElement("div");
    nModal.id = "notifModal";
    nModal.style.cssText = "display:none; position:fixed; top:60px; right:80px; width:300px; background:white; border:1px solid #ddd; box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius:8px; z-index:1000; max-height:400px; overflow-y:auto;";
    nModal.innerHTML = `<div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold;">Alerts & Notifications</div><ul id="notifList" style="list-style:none; padding:0; margin:0;"></ul>`;
    document.body.appendChild(nModal);

    alertBtn.onclick = function (e) {
      e.stopPropagation();
      const m = document.getElementById("notifModal");
      if (m.style.display === "none") {
        fetchNotifications();
        m.style.display = "block";
      } else {
        m.style.display = "none";
      }
    };

    document.addEventListener("click", function (e) {
      const m = document.getElementById("notifModal");
      if (!alertBtn.contains(e.target) && !m.contains(e.target)) {
        m.style.display = "none";
      }
    });

    async function fetchNotifications() {
      const list = document.getElementById("notifList");
      list.innerHTML = "<li style='padding:10px;'>Loading...</li>";

      try {
        const userStr = localStorage.getItem("user");
        if (!userStr) return;
        const user = JSON.parse(userStr);
        const res = await fetch(`http://localhost:8080/api/notifications/${user.id}?role=ADMIN`);
        const data = await res.json();

        list.innerHTML = "";
        if (!data || data.length === 0) {
          list.innerHTML = "<li style='padding:10px; color:#777;'>No new alerts</li>";
          updateNotifBadge(0);
          return;
        }

        updateNotifBadge(data.length);

        data.forEach(n => {
          const li = document.createElement("li");
          li.style.padding = "10px";
          li.style.borderBottom = "1px solid #f0f0f0";
          li.style.fontSize = "13px";
          li.style.cursor = "pointer";
          li.onclick = () => markRead(n.id);
          li.innerHTML = `<div>${n.message}</div><div style='font-size:10px; color:#aaa; margin-top:4px;'>${new Date(n.createdAt).toLocaleString()}</div>`;
          list.appendChild(li);
        });

      } catch (e) {
        console.error(e);
      }
    }

    function updateNotifBadge(count) {
      let badge = document.getElementById("adminNotifBadge");
      if (count > 0) {
        if (!badge) {
          badge = document.createElement("span");
          badge.id = "adminNotifBadge";
          badge.style.cssText = "position:absolute; top:-5px; right:-5px; width:10px; height:10px; background:red; border-radius:50%; border:2px solid white;";
          alertBtn.style.position = "relative";
          alertBtn.appendChild(badge);
        }
      } else if (badge) {
        badge.remove();
      }
    }

    async function markRead(id) {
      await fetch(`http://localhost:8080/api/notifications/${id}/read`, { method: 'PUT' });
      fetchNotifications();
    }

    setInterval(fetchNotifications, 30000);
    fetchNotifications();

    let salesChart;
    function renderSalesChart(monthlySales) {
      const ctx = document.getElementById('salesChart').getContext('2d');

      const labels = monthlySales.map(s => s.month);
      const values = monthlySales.map(s => s.sales);

      if (salesChart) salesChart.destroy();

      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sales Revenue (₹)',
            data: values,
            borderColor: '#0f7d44',
            backgroundColor: 'rgba(15, 125, 68, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#0f7d44'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#f0f0f0' },
              ticks: { font: { size: 12 } }
            },
            x: {
              grid: { display: false },
              ticks: { font: { size: 12 } }
            }
          }
        }
      });
    }
  </script>
  <script src="notifications.js"></script>
</body>

</html>