<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Place Order | FarmerRetailer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root {
  --green: #198754;
}

body { background: #f6f8f7; }

.card {
  border-radius: 14px;
  border: none;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
}

.card-header {
  background: var(--green);
  color: #fff;
  font-weight: 600;
}

.progress-step {
  background: #e9f5ee;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
}

.progress-step.active {
  background: var(--green);
  color: #fff;
}

.qty-input { text-align: center; }

.item-total {
  transition: transform .2s ease;
}
.item-total.updated {
  transform: scale(1.1);
  color: var(--green);
}

.btn-success {
  box-shadow: 0 6px 16px rgba(25,135,84,.35);
  
}

</style>
</head>

<body>

<div class="container my-5">

<!-- Header -->
<div class="text-center mb-4">
  <h2 class="text-success">
    <i class="fas fa-seedling"></i> Complete Your Order
  </h2>

  <div class="d-flex justify-content-center gap-3 mt-3">
    <div class="progress-step active">1. Cart</div>
    <div class="progress-step">2. Delivery</div>
    <div class="progress-step">3. Payment</div>
  </div>
</div>

<div class="row">

<!-- LEFT -->
<div class="col-lg-8">

<!-- Cart -->
<div class="card mb-4">
  <div class="card-header">
    <i class="fas fa-shopping-cart"></i> Order Items
  </div>
  <div class="card-body" id="orderItems"></div>
</div>

<!-- Delivery -->
<div class="card">
  <div class="card-header">
    <i class="fas fa-truck"></i> Delivery Details
  </div>

  <div class="card-body">
    <input class="form-control mb-2" placeholder="Full Name *">
    <input class="form-control mb-2" placeholder="Phone Number *">
    <input class="form-control mb-2" placeholder="Email (optional)">
    <textarea class="form-control" rows="3"
      placeholder="Village, Area, City, PIN Code *"></textarea>
  </div>
</div>

</div>

<!-- RIGHT -->
<div class="col-lg-4">
<div class="card sticky-top" style="top:20px">

<div class="card-header">
  <i class="fas fa-receipt"></i> Order Summary
</div>

<div class="card-body">
  <div class="d-flex justify-content-between mb-2">
    <span><i class="fas fa-box text-muted"></i> Subtotal</span>
    <span id="subtotal">₹0</span>
  </div>

  <div class="d-flex justify-content-between mb-2">
    <span><i class="fas fa-truck text-muted"></i> Shipping</span>
    <span class="text-success">FREE</span>
  </div>

  <hr>

  <div class="d-flex justify-content-between fs-5 fw-bold text-success mb-3">
    <span>Total</span>
    <span id="total">₹0</span>
  </div>

  <button id="placeOrderBtn"
    class="btn btn-success btn-lg w-100">
    <i class="fas fa-check-circle"></i> Place Order
  </button>

  <div class="text-center small text-muted mt-2">
    <i class="fas fa-lock text-success"></i>
    Secure payment via Razorpay
  </div>
</div>

</div>
</div>

</div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const API_URL = "http://localhost:8080/api/products";
const user = JSON.parse(localStorage.getItem("user"));

function img(p) {
  if (!p.imageUrl) return "https://via.placeholder.com/300";

  if (p.imageUrl.startsWith("http")) return p.imageUrl;

  // fallback for old local paths
  return `http://localhost:8080${p.imageUrl}`;
}

function getCart(){
  return JSON.parse(localStorage.getItem("cart")) || [];
}

function saveCart(cart){
  localStorage.setItem("cart", JSON.stringify(cart));
}

async function fetchProductById(id){
  const res = await fetch(`${API_URL}/${id}`);
  return res.json();
}

async function loadCartItems(){
  const cart = getCart();
  const div = document.getElementById("orderItems");
  div.innerHTML = "";

  if(cart.length === 0){
    div.innerHTML = `
      <div class="text-center py-5 text-muted">
        <i class="fas fa-shopping-basket fa-3x mb-3 text-success"></i>
        <h5>Your cart is empty</h5>
        <a href="products.html" class="btn btn-outline-success mt-2">
          Browse Products
        </a>
      </div>`;
    updateSummary([]);
    return;
  }

  let items = [];
  for(const c of cart){
    const p = await fetchProductById(c.id);
    items.push({...p, cartQty: c.qty});
  }

  renderItems(items);
  updateSummary(items);
}

function renderItems(items){
  const div = document.getElementById("orderItems");
  div.innerHTML = "";

  items.forEach(p=>{
    div.innerHTML += `
    <div class="row align-items-center mb-3 border-bottom pb-3">
      <div class="col-2">
        <img src="${img(p)}" class="img-fluid rounded">
      </div>
      <div class="col-4 fw-bold">${p.name}</div>
      <div class="col-2 text-success">₹${p.price}/kg</div>
      <div class="col-2">
        <button class="btn btn-sm btn-outline-success"
          onclick="changeQty(${p.id},-1)">-</button>
        <span class="mx-2">${p.cartQty}</span>
        <button class="btn btn-sm btn-outline-success"
          onclick="changeQty(${p.id},1)">+</button>
      </div>
      <div class="col-2 fw-bold text-success item-total">
        ₹${p.price * p.cartQty}
      </div>
    </div>`;
  });
}

function changeQty(id, diff){
  let cart = getCart();
  let item = cart.find(i=>i.id===id);
  item.qty = Math.max(1, item.qty + diff);
  saveCart(cart);
  loadCartItems();
}

function updateSummary(items){
  const total = items.reduce((s,p)=>s+p.price*p.cartQty,0);
  document.getElementById("subtotal").innerText = `₹${total}`;
  document.getElementById("total").innerText = `₹${total}`;

  document.querySelectorAll(".item-total")
    .forEach(el=>{
      el.classList.add("updated");
      setTimeout(()=>el.classList.remove("updated"),200);
    });
}
async function placeOrderWithPayment() {
  const btn = document.getElementById("placeOrderBtn");
  btn.disabled = true;
  btn.innerHTML = "Processing...";

  try {
    const cart = getCart();
    if (cart.length === 0) {
      alert("Your cart is empty!");
      btn.disabled = false;
      btn.innerHTML = "Place Order";
      return;
    }

    /* ================= 1️⃣ PLACE ORDER IN DB ================= */
    const orderRes = await fetch("http://localhost:8080/api/orders/place-cart", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        retailerId: user.id,
        items: cart.map(c => ({
          productId: c.id,
          quantity: c.qty
        }))
      })
    });

    if (!orderRes.ok) throw new Error("Order creation failed");

    const order = await orderRes.json();
    const orderId = order.id;

    /* ================= 2️⃣ CREATE RAZORPAY ORDER ================= */
    const payRes = await fetch(
      `http://localhost:8080/api/payment/create/${orderId}`,
      { method: "POST" }
    );

    if (!payRes.ok) throw new Error("Razorpay order creation failed");

    const razorOrder = await payRes.json();

    /* ================= 3️⃣ OPEN RAZORPAY ================= */
    const options = {
      key: "rzp_test_S1naQpKeGtkiPp",
      amount: razorOrder.amount,
      currency: "INR",
      order_id: razorOrder.id,

      handler: async function (response) {
        /* ================= 4️⃣ VERIFY PAYMENT ================= */
        const verifyRes = await fetch(
          "http://localhost:8080/api/payment/verify",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              razorpay_order_id: response.razorpay_order_id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature
            })
          }
        );

        const msg = await verifyRes.text();
        alert(msg);

        /* ================= 5️⃣ CLEAR CART & REDIRECT ================= */
        localStorage.removeItem("cart");
        window.location.href = "myorder.html";
      },

      theme: { color: "#16a34a" }
    };

    new Razorpay(options).open();

  } catch (err) {
    console.error(err);
    alert("Payment failed. Please try again.");
    btn.disabled = false;
    btn.innerHTML = "Place Order";
  }
}

window.onload = () => {
  loadCartItems();
  document.getElementById("placeOrderBtn").onclick = placeOrderWithPayment;
};
</script>

</body>
</html>
